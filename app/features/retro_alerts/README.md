## ♻️ Ретроградный «тревожный сигнал»

### Назначение
- Предупреждать пользователя о ближайших ретроградных фазах Меркурия, Венеры и Марса.
- Разделять сценарий для бесплатных и премиум-пользователей.
- Автоматически отправлять уведомления за 3 дня до начала и в день старта ретроградности.

### Пользовательский сценарий
1. Бот рассчитывает периоды ретро заранее (по умолчанию — на 120 дней вперёд).
2. Free-юзер получает только оповещения/информацию по Меркурию; Premium — по Венере и Марсу с расширенными чек-листами.
3. Команда `/retro_alerts` (кнопка «♻️ Ретроградный сигнал») показывает ближайшие периоды и даты предупреждений.
4. Авторассылка (11:00 локального времени пользователя):
   - За три дня до начала приходит «сделать заранее» + промо (если free).
   - В день старта — «как вести себя в период» + чек-лист для Premium.

### Реализация
- `app/shared/astro/retrograde.py` — `RetrogradeService`:
  - Рассчитывает периоды по `flatlib` (транзитные скорости планет).
  - Формирует тексты (free/premium) и чек-листы для разных планет.
- `app/shared/storage.py` — хранит флаг `retro_alerts` для каждого пользователя, чтобы не слать дубли.
- `app/scheduler.py` — метод `_send_retrograde_alerts` обходит всех юзеров, проверяет локальное время, подписку и отправляет сообщения.
- `app/features/retro_alerts/router.py` — команда `/retro_alerts` с учётом статуса пользователя и таймзоны.
- `app/shared/messages.py` — текстовые шаблоны (free/premium, промо).
- `app/shared/keyboards/main.py` — добавлена кнопка «♻️ Ретроградный сигнал».

### Premium vs Free
- Free: только Меркурий (превью + блок о премиум).
- Premium: все три планеты + расширенные списки действий до и во время ретро.

### Критичные детали
- Оповещения проверяются «каждую минуту» вместе с другими задачами планировщика, но отправляются только в 11:00 по локальному времени пользователя.
- `retro_alerts` в `user_storage`: сохраняются даты последнего pre-alert и start-alert для каждой планеты.
- При отсутствии таймзоны — fallback в UTC.
- Добавлен `tzdata` в зависимости (для Windows) и используется `ZoneInfo`.

### Проверка
```
# ручной запрос ближайших периодов
python - <<'PY'
from datetime import date
from app.shared.astro import retrograde_service
print(retrograde_service.get_periods(date(2025,11,1), date(2026,1,31)))
PY

# тест отправки из планировщика
python - <<'PY'
# см. кусок run_test в scheduler или используйте FakeBot
PY

# команда
/retro_alerts
```

### TODO на будущее
- Добавить планет больше (Юпитер/Сатурн и т.д.) — простым расширением `tracked_planets` и `GUIDES`.
- Локализовать тексты под другие языки при необходимости.
- Настройка индивидуального времени отправки (сейчас общее 11:00).
