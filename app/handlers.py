"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π FSM –∏ UserStorage
"""

import logging

from aiogram import Router
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import Message
from calculations import calculate_daily_number, calculate_life_path_number, calculate_soul_number
from decorators import error_handler
from messages import MESSAGES

from app.user_storage import user_storage

logger = logging.getLogger(__name__)
router = Router()


class UserStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è FSM"""

    waiting_for_birth_date = State()
    waiting_for_other_date = State()


# ------------------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ -------------------


@router.message(Command("start"))
@error_handler(MESSAGES.ERROR_START)
async def start_command(message: Message):
    user_id = message.from_user.id
    user_storage.get_user(user_id)  # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await message.answer(MESSAGES.START)


@router.message(Command("help"))
async def help_command(message: Message):
    await message.answer(MESSAGES.HELP)


@router.message(Command("subscription"))
async def subscription_command(message: Message):
    user_id = message.from_user.id
    subscription = user_storage.get_user(user_id).get("subscription", {})

    if subscription.get("active"):
        expires = subscription.get("expires", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        sub_type = subscription.get("type", "standard")
        await message.answer(f"‚úÖ –£ —Ç–µ–±—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ ({sub_type}), –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {expires}")
    else:
        await message.answer("‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏. –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.")


# ------------------- –ü—É—Ç—å –∂–∏–∑–Ω–∏ -------------------


@router.message(Command("life_path"))
@error_handler(MESSAGES.ERROR_LIFE_PATH)
async def life_path_command(message: Message):
    user_id = message.from_user.id

    if not user_storage.can_make_request(user_id):
        await message.answer(MESSAGES.LIMIT_REACHED)
        return

    cache = user_storage.get_cached_result(user_id)
    if cache and cache.get("life_path_result") and user_storage.can_view_cached_result(user_id):
        user_storage.increment_repeat_view(user_id)
        await message.answer(f"‚ôªÔ∏è –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n{cache['life_path_result']}")
        return

    birth_date = user_storage.get_user(user_id).get("birth_date")
    if not birth_date:
        await message.answer(MESSAGES.NO_BIRTHDATE)
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.MM.–ì–ì–ì–ì")
        await message.bot.set_state(user_id, UserStates.waiting_for_birth_date)
        return

    await calculate_and_send_life_path(user_id, message)


async def calculate_and_send_life_path(user_id: int, message: Message):
    birth_date = user_storage.get_user(user_id).get("birth_date")
    life_path = calculate_life_path_number(birth_date)
    soul_number = calculate_soul_number(birth_date)

    user_storage.save_daily_result(user_id, birth_date, life_path, soul_number)
    user_storage.increment_usage(user_id, "daily")

    await message.answer(f"üåü –¢–≤–æ–π –ø—É—Ç—å –∂–∏–∑–Ω–∏: {life_path}")


@router.message(UserStates.waiting_for_birth_date)
async def input_birth_date(message: Message, state: FSMContext):
    user_id = message.from_user.id
    birth_date = message.text.strip()

    if not birth_date or not birth_date.count(".") == 2:
        await message.answer(MESSAGES.INVALID_DATE)
        return

    try:
        user_storage.set_birth_date(user_id, birth_date)
    except Exception:
        await message.answer(MESSAGES.INVALID_DATE)
        return

    await state.clear()
    await calculate_and_send_life_path(user_id, message)


# ------------------- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å -------------------


@router.message(Command("compatibility"))
@error_handler(MESSAGES.ERROR_COMPATIBILITY)
async def compatibility_command(message: Message, state: FSMContext):
    user_id = message.from_user.id
    if not user_storage.can_check_compatibility(user_id):
        await message.answer(MESSAGES.COMPATIBILITY_LIMIT)
        return

    birth_date = user_storage.get_user(user_id).get("birth_date")
    if not birth_date:
        await message.answer(MESSAGES.NO_BIRTHDATE)
        await state.set_state(UserStates.waiting_for_birth_date)
        return

    await message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ (–î–î.MM.–ì–ì–ì–ì):")
    await state.set_state(UserStates.waiting_for_other_date)


@router.message(UserStates.waiting_for_other_date)
async def input_other_birth_date(message: Message, state: FSMContext):
    user_id = message.from_user.id
    other_date = message.text.strip()

    birth_date = user_storage.get_user(user_id).get("birth_date")
    if not birth_date:
        await message.answer(MESSAGES.NO_BIRTHDATE)
        await state.clear()
        return

    try:
        score = calculate_life_path_number(birth_date)  # —É–ø—Ä–æ—â–∞–µ–º: —á–∏—Å–ª–æ —Å—É–¥—å–±—ã
        other_number = calculate_life_path_number(other_date)
        compatibility = 9 - abs(score - other_number)  # –ø—Ä–æ—Å—Ç–∞—è –º–µ—Ç—Ä–∏–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    except Exception:
        await message.answer(MESSAGES.INVALID_DATE)
        await state.clear()
        return

    user_storage.increment_usage(user_id, "compatibility")
    await message.answer(f"üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {compatibility}/9")
    await state.clear()


# ------------------- –ê—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏ -------------------


@router.message(Command("affirmation"))
@error_handler(MESSAGES.ERROR_AFFIRMATION)
async def affirmation_command(message: Message):
    user_id = message.from_user.id

    todays_aff = user_storage.get_todays_affirmation(user_id)
    if todays_aff:
        await message.answer(f"‚ú® –¢–≤–æ—è –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—è:\n{todays_aff['text']}")
        return

    number, text = get_random_affirmation()
    user_storage.set_todays_affirmation(user_id, text, number)
    await message.answer(f"‚ú® –¢–≤–æ—è –Ω–æ–≤–∞—è –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—è:\n{text}")


# ------------------- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —á–∏—Å–ª–æ -------------------


@router.message(Command("daily"))
@error_handler(MESSAGES.ERROR_DAILY_NUMBER)
async def daily_number_command(message: Message):
    user_id = message.from_user.id

    if not user_storage.can_make_request(user_id):
        await message.answer(MESSAGES.LIMIT_REACHED)
        return

    cache = user_storage.get_cached_result(user_id)
    if cache and cache.get("daily_number_result") and user_storage.can_view_cached_result(user_id):
        user_storage.increment_repeat_view(user_id)
        await message.answer(f"‚ôªÔ∏è –¢–≤–æ–µ —á–∏—Å–ª–æ –¥–Ω—è:\n{cache['daily_number_result']}")
        return

    birth_date = user_storage.get_user(user_id).get("birth_date")
    if not birth_date:
        await message.answer(MESSAGES.NO_BIRTHDATE)
        return

    daily_num = calculate_daily_number(birth_date)
    cache_data = user_storage.get_cached_result(user_id) or {}
    cache_data["daily_number_result"] = daily_num
    user_storage.data[str(user_id)]["daily_cache"].update(cache_data)
    user_storage.increment_usage(user_id, "daily")

    await message.answer(f"üîÆ –¢–≤–æ–µ —á–∏—Å–ª–æ –¥–Ω—è: {daily_num}")


# ------------------- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é -------------------


@router.message(Command("set_birthdate"))
@error_handler(MESSAGES.ERROR_SET_BIRTHDATE)
async def set_birthdate_command(message: Message):
    user_id = message.from_user.id
    args = message.text.split()
    if len(args) < 2:
        await message.answer(MESSAGES.NO_DATE_PROVIDED)
        return

    birth_date = args[1]
    try:
        user_storage.set_birth_date(user_id, birth_date)
    except Exception:
        await message.answer(MESSAGES.INVALID_DATE)
        return

    await message.answer(MESSAGES.BIRTHDATE_SAVED.format(birth_date=birth_date))
